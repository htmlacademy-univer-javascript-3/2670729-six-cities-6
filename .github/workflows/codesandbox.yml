name: CodeSandbox Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    name: Deploy to CodeSandbox
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate CodeSandbox URL and comment PR
        id: codesandbox
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ PR –∏–∑ —Å–æ–±—ã—Ç–∏—è
              const prEvent = context.payload.pull_request;
              const prNumber = context.issue.number;
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
              const headRepo = prEvent.head.repo;
              const baseRepo = prEvent.base.repo;
              const isCrossRepo = headRepo.full_name !== baseRepo.full_name;
              
              // –î–ª—è cross-repo PR –∏—Å–ø–æ–ª—å–∑—É–µ–º head —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ñ–æ—Ä–∫)
              // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ PR –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              const repoOwner = isCrossRepo ? headRepo.owner.login : context.repo.owner;
              const repoName = isCrossRepo ? headRepo.name : context.repo.repo;
              const branchName = prEvent.head.ref;
              
              // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è CodeSandbox –Ω–∞ –æ—Å–Ω–æ–≤–µ head —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
              const codesandboxUrl = `https://codesandbox.io/s/github/${headRepo.owner.login}/${headRepo.name}/tree/${branchName}`;
              
              const commentBody = `## üöÄ Preview –≤ CodeSandbox
              
              –ü—Ä–æ–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ CodeSandbox:
              
              üîó **[–û—Ç–∫—Ä—ã—Ç—å –≤ CodeSandbox](${codesandboxUrl})**
              
              > Branch: \`${branchName}\`
              > Repository: \`${headRepo.full_name}\`
              ${isCrossRepo ? '> ‚ö†Ô∏è *Cross-repository PR - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω*' : ''}
              > 
              > –°—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–∞—Ö –≤ PR.`;
              
              // –ü—ã—Ç–∞–µ–º—Å—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ü–µ–ª–µ–≤–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (base)
              // –î–ª—è cross-repo PR —ç—Ç–æ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
              const targetOwner = baseRepo.owner.login;
              const targetRepo = baseRepo.name;
              
              try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
                const comments = await github.rest.issues.listComments({
                  owner: targetOwner,
                  repo: targetRepo,
                  issue_number: prNumber,
                });
                
                const botComment = comments.data.find(
                  comment => comment.user.type === 'Bot' && 
                  comment.body.includes('CodeSandbox')
                );
                
                if (botComment) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                  await github.rest.issues.updateComment({
                    owner: targetOwner,
                    repo: targetRepo,
                    comment_id: botComment.id,
                    body: commentBody
                  });
                  console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                } else {
                  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                  await github.rest.issues.createComment({
                    owner: targetOwner,
                    repo: targetRepo,
                    issue_number: prNumber,
                    body: commentBody
                  });
                  console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
                }
              } catch (commentError) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, cross-repo PR –±–µ–∑ –ø—Ä–∞–≤),
                // –≤—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–≥–∏ –∏ –Ω–µ –ø–∞–¥–∞–µ–º
                if (commentError.status === 403 || commentError.status === 404) {
                  console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR (–≤–æ–∑–º–æ–∂–Ω–æ, cross-repository –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è): ${commentError.message}`);
                  console.log(`\nüîó –°—Å—ã–ª–∫–∞ –Ω–∞ CodeSandbox: ${codesandboxUrl}`);
                  console.log('–í—ã –º–æ–∂–µ—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ–ø–∏—Å–∞–Ω–∏–µ PR –≤—Ä—É—á–Ω—É—é.');
                  
                  // –í—ã–≤–æ–¥–∏–º —Å—Å—ã–ª–∫—É –≤ summary workflow
                  const fs = require('fs');
                  const summaryPath = process.env.GITHUB_STEP_SUMMARY;
                  if (summaryPath) {
                    const summary = `## üöÄ Preview –≤ CodeSandbox\n\n**‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è cross-repository PR**\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ PR:\n\nüîó **[${codesandboxUrl}](${codesandboxUrl})**\n\n> Branch: \`${branchName}\`\n> Repository: \`${headRepo.full_name}\``;
                    fs.appendFileSync(summaryPath, summary);
                  }
                } else {
                  throw commentError;
                }
              }
              
              return { url: codesandboxUrl };
            } catch (error) {
              console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ PR: ${error.message}`);
              // –ù–µ –ø–∞–¥–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≤–µ—Å—å workflow
              console.log('Workflow –∑–∞–≤–µ—Ä—à–µ–Ω —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º');
            }

